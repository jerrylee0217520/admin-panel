<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>佳元松江社區 停車管理中心</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom scrollbar styles */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f5f6fa;
    }
    ::-webkit-scrollbar-thumb {
      background: #c5d0d8;
      border-radius: 4px;
    }
    html, body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
      color: #333;
    }
    .record-card {
      background-color: #f8f9fa;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex; justify-content: center; align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white; padding: 2rem; border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body class="antialiased p-4">
  <div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-lg mt-8">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">佳元松江社區 停車管理中心</h1>
    <p class="text-gray-600 text-center mb-6">手動管理停車記錄</p>
    
    <div id="loading" class="text-center text-gray-500 hidden">
      <div class="flex justify-center items-center">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>載入中...</span>
      </div>
    </div>

    <div id="error-message" class="text-red-500 text-center mb-4 hidden"></div>

    <div id="content">
      <div class="mb-6 border p-4 rounded-xl shadow-inner bg-gray-50">
        <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">新增停車記錄</h2>
        <div class="space-y-4">
          <div>
            <label for="carPlate" class="block text-sm font-medium text-gray-700">車牌號碼:</label>
            <input type="text" id="carPlate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
          </div>
          <div>
            <label for="huBei" class="block text-sm font-medium text-gray-700">戶別:</label>
            <input type="text" id="huBei" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
          </div>
          <button id="addRecordBtn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">新增停車</button>
        </div>
      </div>
      
      <div class="mt-8">
        <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">當前停車列表</h2>
        <div id="parking-list" class="space-y-4">
          <!-- Parking records will be dynamically added here -->
        </div>
      </div>

      <div class="mt-8 flex justify-center space-x-4">
        <button id="exportCsvBtn" class="py-2 px-4 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition">
          匯出所有記錄 (CSV)
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = {
      apiKey: "AIzaSyDeRHsloR1iY0_bzpYbPzdCiBljGfck98k",
      authDomain: "jy-2025.firebaseapp.com",
      projectId: "jy-2025",
      storageBucket: "jy-2025.firebasestorage.app",
      messagingSenderId: "640527461851",
      appId: "1:640527461851:web:eed9f82d698275371fcbfe",
      measurementId: "G-HVEVMTSR9L"
    };
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db;
    let auth;
    let userId;
    const collectionPath = `/artifacts/${appId}/public/data/parking-records`;

    const carPlateInput = document.getElementById('carPlate');
    const huBeiInput = document.getElementById('huBei');
    const addRecordBtn = document.getElementById('addRecordBtn');
    const parkingList = document.getElementById('parking-list');
    const loadingEl = document.getElementById('loading');
    const errorMessageEl = document.getElementById('error-message');
    const exportCsvBtn = document.getElementById('exportCsvBtn');

    // 簡化的戶別對應表
    const huBeiMap = {
        '10A': '10A-10樓', '10B': '10B-10樓',
        '9A': '9A-9樓', '9B': '9B-9樓',
        '8A': '8A-8樓', '8B': '8B-8樓',
        '7A': '7A-7樓', '7B': '7B-7樓', '7C': '7C-7樓', '7D': '7D-7樓', '7E': '7E-7樓', '7F': '7F-7樓',
        '6A': '6A-6樓', '6B': '6B-6樓', '6C': '6C-6樓', '6D': '6D-6樓', '6E': '6E-6樓', '6F': '6F-6樓',
        '5A': '5A-5樓', '5B': '5B-5樓', '5C': '5C-5樓', '5D': '5D-5樓', '5E': '5E-5樓', '5F': '5F-5樓',
        '4A': '4A-4樓', '4B': '4B-4樓', '4CD': '4CD-4樓', '4EF': '4EF-4樓',
        '3A': '3A-3樓', '3B': '3B-3樓', '3CD': '3CD-3樓', '3EF': '3EF-3樓',
        '2A': '2A-2樓', '2B': '2B-2樓', '2C': '2C-2樓', '2D': '2D-2樓', '2E': '2E-2樓', '2F': '2F-2樓',
        '1A': '1A-1樓', '1B': '1B-1樓', '施工': '施工'
    };
    
    // 儲存所有記錄，用於匯出
    let allRecords = [];

    function showLoading(show) {
      loadingEl.classList.toggle('hidden', !show);
      document.getElementById('content').classList.toggle('hidden', show);
    }

    function showError(message) {
      errorMessageEl.textContent = message;
      errorMessageEl.classList.remove('hidden');
    }

    function hideError() {
      errorMessageEl.classList.add('hidden');
    }

    async function initializeAppAndAuth() {
      showLoading(true);
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            setupRealtimeListener();
          } else {
            console.error('User not signed in.');
            showError('無法驗證使用者。');
          }
        });
      } catch (e) {
        console.error("Initialization failed:", e);
        showError("應用程式初始化失敗，請檢查網路連線。");
        showLoading(false);
      }
    }

    function setupRealtimeListener() {
      try {
        const collectionRef = collection(db, collectionPath);
        onSnapshot(collectionRef, (snapshot) => {
          allRecords = [];
          snapshot.forEach(doc => {
            allRecords.push({ id: doc.id, ...doc.data() });
          });
          renderParkingList(allRecords.filter(record => !record.leaveTime));
          showLoading(false);
        }, (error) => {
          console.error("Failed to listen to Firestore:", error);
          showError("無法即時更新停車記錄。");
          showLoading(false);
        });
      } catch (e) {
        console.error("Failed to set up Firestore listener:", e);
        showError("設定數據監聽失敗。");
        showLoading(false);
      }
    }

    function renderParkingList(records) {
      parkingList.innerHTML = '';
      if (records.length === 0) {
        parkingList.innerHTML = `<p class="text-gray-500 text-center">目前沒有停車記錄。</p>`;
        return;
      }
      records.forEach(record => {
        const recordEl = document.createElement('div');
        recordEl.className = 'record-card flex items-center justify-between p-4 bg-gray-100 rounded-lg shadow-sm';
        
        // 格式化停放時間
        const parkingTime = new Date(record.parkingTime).toLocaleString('zh-TW', { hour12: false });

        recordEl.innerHTML = `
          <div class="flex-grow">
            <p class="font-bold text-gray-800">${record.carPlate} - ${record.huBei}</p>
            <p class="text-xs text-gray-600">停放時間: ${parkingTime}</p>
          </div>
          <div class="flex space-x-2">
            <button data-id="${record.id}" class="leave-btn py-1 px-3 border border-transparent rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150">
              離開
            </button>
            <button data-id="${record.id}" class="delete-btn py-1 px-3 border border-transparent rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition duration-150">
              移除
            </button>
          </div>
        `;
        parkingList.appendChild(recordEl);
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteRecord(btn.dataset.id));
      });
      document.querySelectorAll('.leave-btn').forEach(btn => {
        btn.addEventListener('click', () => leaveRecord(btn.dataset.id));
      });
    }

    async function addRecord() {
      const carPlate = carPlateInput.value.trim();
      let huBei = huBeiInput.value.trim();

      if (!carPlate || !huBei) {
        showError('車牌號碼和戶別不能為空。');
        return;
      }
      hideError();
      
      // 自動補全戶別
      if (huBeiMap[huBei]) {
          huBei = huBeiMap[huBei];
      }

      try {
        const docRef = doc(collection(db, collectionPath));
        await setDoc(docRef, {
          carPlate,
          huBei,
          parkingTime: new Date().toISOString()
        });
        carPlateInput.value = '';
        huBeiInput.value = '';
      } catch (e) {
        console.error("Failed to add record:", e);
        showError("新增記錄失敗。請重試。");
      }
    }

    async function leaveRecord(id) {
        try {
            const docRef = doc(db, collectionPath, id);
            await updateDoc(docRef, {
                leaveTime: new Date().toISOString()
            });
        } catch (e) {
            console.error("Failed to leave record:", e);
            showError("更新記錄失敗。請重試。");
        }
    }

    async function deleteRecord(id) {
      try {
        const docRef = doc(db, collectionPath, id);
        await deleteDoc(docRef);
      } catch (e) {
        console.error("Failed to delete record:", e);
        showError("刪除記錄失敗。請重試。");
      }
    }

    function downloadCsv(data, filename) {
        const csvRows = [
            ["車牌號碼", "戶別", "停放時間", "離開時間"]
        ];
        data.forEach(row => {
            const parkingTime = new Date(row.parkingTime).toLocaleString('zh-TW', { hour12: false });
            const leaveTime = row.leaveTime ? new Date(row.leaveTime).toLocaleString('zh-TW', { hour12: false }) : '';
            csvRows.push([
                row.carPlate,
                row.huBei,
                parkingTime,
                leaveTime
            ]);
        });

        const csvString = csvRows.map(row => row.join(',')).join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    exportCsvBtn.addEventListener('click', () => {
        downloadCsv(allRecords, `parking_records_${new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' })}.csv`);
    });

    addRecordBtn.addEventListener('click', addRecord);
    window.addEventListener('DOMContentLoaded', initializeAppAndAuth);
  </script>
</body>
</html>