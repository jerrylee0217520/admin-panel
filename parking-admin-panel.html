<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>停車管理中心</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f2f5; }
    .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .btn { transition: all 0.2s ease-in-out; }
    .btn:hover { transform: translateY(-2px); }
    #records-table-body tr:hover { background-color: #eff6ff; }
  </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

  <div class="max-w-7xl mx-auto">
    <header class="mb-8 text-center">
      <h1 class="text-3xl font-bold text-gray-800">佳元松江社區 停車管理中心</h1>
      <div class="mt-4">
        <button id="auth-button" class="btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">登入 Google</button>
      </div>
      <p id="user-status" class="mt-2 text-sm text-gray-500">正在初始化...</p>
    </header>

    <main id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-6 hidden">
      
      <div class="lg:col-span-1 flex flex-col gap-6">
        <div class="card p-6">
          <h2 class="text-xl font-bold mb-4">新增停車記錄</h2>
          <form id="new-record-form" class="space-y-4">
            <div>
              <label for="license-plate-input" class="block text-sm font-medium text-gray-700">車牌號碼:</label>
              <input type="text" id="license-plate-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="ABC-1234">
            </div>
            <div>
              <label for="unit-input" class="block text-sm font-medium text-gray-700">戶別:</label>
              <input type="text" id="unit-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="輸入簡碼後將自動匹配">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">車位狀態:</label>
                <p id="spot-status-display" class="mt-1 text-lg font-bold text-gray-800">-</p>
            </div>
            <button type="submit" class="w-full btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">
              新增停車
            </button>
          </form>
        </div>

        <div class="card p-6">
          <h2 class="text-xl font-bold mb-4">在場車輛 (即時)</h2>
          <div id="vehicles-present-container" class="space-y-3">
            <p class="text-gray-500">正在讀取中...</p>
          </div>
        </div>
      </div>

      <div class="lg:col-span-2 flex flex-col gap-6">
        <div class="card p-6">
            <h2 class="text-xl font-bold mb-4">數據分析</h2>
            <p class="text-sm text-gray-600 mb-4">所選日期各時段入場車流量分析</p>
            <div class="h-64">
              <canvas id="entry-time-chart"></canvas>
            </div>
        </div>
        <div class="card p-6">
          <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
              <h2 class="text-xl font-bold">停車總記錄 (<span id="selected-date-display" class="text-blue-600"></span>)</h2>
              <div class="flex items-center gap-2">
                  <input type="date" id="date-picker-input" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                  <input type="text" id="search-input" class="w-full sm:w-56 block rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="搜尋車牌或戶別...">
              </div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">車牌號碼</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">戶別</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">車位編號</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">入場時間</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">出場時間</th>
                  <th class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 uppercase tracking-wider">停放時長 (分)</th>
                </tr>
              </thead>
              <tbody id="records-table-body" class="bg-white divide-y divide-gray-200">
              </tbody>
            </table>
          </div>
          <div class="mt-6 text-right">
              <button id="export-csv-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                  匯出所選日期記錄 (CSV)
              </button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc, addDoc, getDocs, collection, query, where, onSnapshot, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, getRedirectResult } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDeRHsloR1iY0_bzpYbPzdCiBljGfck98k",
      authDomain: "jy-2025.firebaseapp.com",
      projectId: "jy-2025",
      storageBucket: "jy-2025.appspot.com",
      messagingSenderId: "640527461851",
      appId: "1:640527461851:web:eed9f82d698275371fcbfe",
    };
    
    const allHuBeiList = [
        '10A-10樓', '10B-10樓', '9A-9樓', '9B-9樓', '8A-8樓', '8B-8樓', '7A-7樓', '7B-7樓', '7C-7樓', '7D-7樓', '7E-7樓', '7F-7樓', '6A-6樓', '6B-6樓', '6C-6樓', '6D-6樓', '6E-6樓', '6F-6樓', '5A-5樓', '5B-5樓', '5C-5樓', '5D-5樓', '5E-5樓', '5F-5樓', '4A-4樓', '4B-4樓', '4CD-4樓', '4EF-4樓', '3A-3樓', '3B-3樓', '3CD-3樓', '3EF-3樓', '2A-2樓', '2B-2樓', '2C-2樓', '2D-2樓', '2E-2樓', '2F-2樓', '1A-1樓', '1B-1樓', '施工', '貴賓'
    ];

    const App = {
      db: null, auth: null, user: null,
      elements: {},
      records: [], vehicles: [], entryTimeChart: null, selectedDate: '',
      retrievedSpotNumber: '',
      isAuthReady: false,

      init() {
        const app = initializeApp(firebaseConfig);
        this.db = getFirestore(app);
        this.auth = getAuth(app);
        
        this.cacheDOMElements();
        this.bindEvents();
        this.handleRedirectResult(); // 雖然改用 Popup，但保留此函式以防萬一
        this.initAuthWatcher();
        this.initChart();
      },

      cacheDOMElements() {
        this.elements = {
          authButton: document.getElementById('auth-button'),
          userStatus: document.getElementById('user-status'),
          mainContent: document.getElementById('main-content'),
          newRecordForm: document.getElementById('new-record-form'),
          licensePlateInput: document.getElementById('license-plate-input'),
          unitInput: document.getElementById('unit-input'),
          spotStatusDisplay: document.getElementById('spot-status-display'),
          vehiclesPresentContainer: document.getElementById('vehicles-present-container'),
          recordsTableBody: document.getElementById('records-table-body'),
          searchInput: document.getElementById('search-input'),
          exportCsvBtn: document.getElementById('export-csv-btn'),
          chartCanvas: document.getElementById('entry-time-chart'),
          datePickerInput: document.getElementById('date-picker-input'),
          selectedDateDisplay: document.getElementById('selected-date-display'),
        };
      },

      bindEvents() {
        this.elements.authButton.addEventListener('click', () => this.handleAuth());
        this.elements.newRecordForm.addEventListener('submit', (e) => this.addRecord(e));
        this.elements.unitInput.addEventListener('change', (e) => this.handleHuBeiChange(e.target.value));
        this.elements.vehiclesPresentContainer.addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON') { this.checkOut(e.target.dataset.id); }
        });
        this.elements.searchInput.addEventListener('input', (e) => this.filterRecords(e.target.value));
        this.elements.exportCsvBtn.addEventListener('click', () => this.exportToCsv());
        this.elements.datePickerInput.addEventListener('change', (e) => this.fetchAndDisplayRecords(e.target.value));
      },
      
      initAuthWatcher() {
        onAuthStateChanged(this.auth, async (user) => {
          this.user = user;
          
          if (user) {
              console.log("登入成功，使用者 UID:", user.uid);
              this.elements.userStatus.textContent = `正在驗證權限...`;
              
              try {
                  const isAdmin = await this.checkAdminStatus(user.uid);
                  this.updateAuthUI(isAdmin);
              } catch (error) {
                  console.error("驗證權限失敗：", error);
                  this.elements.userStatus.textContent = "驗證權限失敗，請檢查網路連線或安全規則。";
                  this.elements.mainContent.classList.add('hidden');
              }
          } else {
              console.log("已登出，使用者 UID: 無");
              this.elements.userStatus.textContent = '請使用管理員帳號登入以繼續。';
              this.elements.authButton.textContent = '登入 Google';
              this.elements.mainContent.classList.add('hidden');
              this.isAuthReady = true; 
          }
        });
      },

      async checkAdminStatus(uid) {
          const adminsRef = collection(this.db, 'admins');
          try {
              const adminDoc = await getDoc(doc(adminsRef, uid));
              return adminDoc.exists();
          } catch (error) {
              // 在權限不足的情況下，Firestore 會拋出錯誤，這也代表不是管理員
              if (error.code === 'permission-denied') {
                  return false;
              }
              // 對其他錯誤，拋出以讓上層處理
              throw error;
          }
      },

      async handleRedirectResult() {
        this.elements.userStatus.textContent = "正在驗證登入狀態...";
        try {
            const result = await getRedirectResult(this.auth);
            if (result) {
                console.log("[DEBUG] Redirect result processed for user:", result.user.email);
            }
        } catch (error) {
            console.error("[DEBUG] Error processing redirect result:", error);
            this.elements.userStatus.textContent = "登入驗證失敗，請重試。";
        }
      },

      async handleAuth() {
        if (this.user) {
          await signOut(this.auth);
        } else {
          const provider = new GoogleAuthProvider();
          provider.setCustomParameters({
            prompt: 'select_account'
          });
          
          try {
            // **核心修正：從重新導向登入改為彈出視窗登入**
            await signInWithPopup(this.auth, provider);
            // 由於 onAuthStateChanged 會自動處理，這裡不需要額外操作
          } catch (error) {
            // 處理彈出視窗登入可能產生的錯誤
            console.error("彈出視窗登入失敗:", error);
            alert("登入失敗，請檢查網路連線或稍後再試。");
          }
        }
      },
      
      updateAuthUI(isAdmin) {
        if (this.user) {
            if (isAdmin) {
                this.elements.userStatus.textContent = `管理員已登入: ${this.user.displayName || this.user.email}`;
                this.elements.authButton.textContent = '登出';
                this.elements.mainContent.classList.remove('hidden');
                if (!this.selectedDate) {
                    this.initDatePicker();
                    this.fetchAndDisplayRecords(this.selectedDate);
                    this.listenForPresentVehicles();
                }
            } else {
               this.elements.userStatus.textContent = `登入身份: ${this.user.displayName || this.user.email} (非管理員，無權限)`;
               this.elements.authButton.textContent = '登出';
               this.elements.mainContent.classList.add('hidden');
            }
        } else {
          this.elements.userStatus.textContent = '請使用管理員帳號登入以繼續。';
          this.elements.authButton.textContent = '登入 Google';
          this.elements.mainContent.classList.add('hidden');
        }
      },
      
      initDatePicker() {
          this.selectedDate = new Date().toISOString().split('T')[0];
          this.elements.datePickerInput.value = this.selectedDate;
          this.elements.selectedDateDisplay.textContent = this.selectedDate;
      },

      initChart() {
        const ctx = this.elements.chartCanvas.getContext('2d');
        this.entryTimeChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: Array.from({ length: 24 }, (_, i) => `${i}時`), datasets: [{ label: '入場車輛數', data: new Array(24).fill(0), backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
        });
      },

      findFullHuBei(shorthandInput) {
        const input = String(shorthandInput).toUpperCase().trim();
        if (!input) return shorthandInput;
        if (input === 'VIP') return '貴賓';
        const matchedHuBei = allHuBeiList.find(fullHuBei => fullHuBei.toUpperCase().startsWith(input));
        return matchedHuBei || shorthandInput;
      },

      async handleHuBeiChange(unitId) {
        const fullUnitId = this.findFullHuBei(unitId);
        this.elements.unitInput.value = fullUnitId;
        const unit = fullUnitId.trim().toUpperCase();
        if (!unit) {
            this.elements.spotStatusDisplay.textContent = '-';
            this.retrievedSpotNumber = '';
            return;
        }
        this.elements.spotStatusDisplay.textContent = '查詢中...';
        const spotRef = doc(this.db, 'unit_parking_spots', unit);
        try {
            const spotSnap = await getDoc(spotRef);
            if (spotSnap.exists()) {
                const spotNumber = spotSnap.data().spotNumber || '資料有誤';
                this.elements.spotStatusDisplay.textContent = spotNumber;
                this.retrievedSpotNumber = spotNumber;
            } else {
                this.elements.spotStatusDisplay.textContent = '無';
                this.retrievedSpotNumber = '';
            }
        } catch (error) {
            console.error("查詢車位失敗:", error);
            this.elements.spotStatusDisplay.textContent = '查詢失敗';
        }
      },

      handleFirestoreError(error, element, type = 'table') {
        console.error("Firestore Error:", error);
        let userMessage = "讀取資料時發生未知錯誤。";
        switch (error.code) {
            case 'failed-precondition': userMessage = "讀取失敗：缺少資料庫索引。請按 F12 打開 Console，點擊錯誤訊息中的連結來自動建立。"; break;
            case 'permission-denied': userMessage = "讀取失敗：權限不足。請登入管理員帳號，或檢查 Firebase 安全規則設定。"; break;
            case 'unavailable': userMessage = "讀取失敗：無法連線至資料庫，請檢查您的網路連線。"; break;
        }
        if (type === 'table') {
            const colspan = 6;
            element.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-red-500 py-4">${userMessage}</td></tr>`;
        } else {
            element.innerHTML = `<div class="p-3 bg-red-100 text-red-700 rounded-lg">${userMessage}</div>`;
        }
      },

      async fetchAndDisplayRecords(dateStr) {
        if (!dateStr) return;
        this.selectedDate = dateStr;
        this.elements.datePickerInput.value = this.selectedDate;
        this.elements.selectedDateDisplay.textContent = this.selectedDate;
        this.elements.recordsTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-4">正在讀取中...</td></tr>`;
        const recordsRef = collection(this.db, 'parking_records');
        const q = query(recordsRef, where("entryDate", "==", dateStr));
        try {
            const querySnapshot = await getDocs(q);
            this.records = [];
            querySnapshot.forEach(doc => { this.records.push({ id: doc.id, ...doc.data() }); });
            this.records.sort((a,b) => (b.entryTime?.seconds || 0) - (a.entryTime?.seconds || 0));
            this.displayRecords();
            this.updateChart();
        } catch(error) {
            this.handleFirestoreError(error, this.elements.recordsTableBody, 'table');
        }
      },

      listenForPresentVehicles() {
        const recordsRef = collection(this.db, 'parking_records');
        const q = query(recordsRef, where("status", "==", "present"));
        onSnapshot(q, (snapshot) => {
            this.vehicles = [];
            snapshot.forEach(doc => { this.vehicles.push({ id: doc.id, ...doc.data() }); });
            this.displayPresentVehicles();
          }, (error) => {
            this.handleFirestoreError(error, this.elements.vehiclesPresentContainer, 'div');
          }
        );
      },

      parseTimestamp(timestamp) {
        if (!timestamp) return null;
        if (typeof timestamp.toDate === 'function') return timestamp.toDate();
        return new Date(timestamp);
      },

      displayRecords(recordsToDisplay = this.records) {
        this.elements.recordsTableBody.innerHTML = '';
        if (recordsToDisplay.length === 0) {
          this.elements.recordsTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-4">該日期無停車記錄。</td></tr>`;
          return;
        }
        recordsToDisplay.forEach(record => {
          const entry = this.parseTimestamp(record.entryTime);
          const exit = this.parseTimestamp(record.exitTime);
          const duration = (entry && exit) ? Math.round((exit - entry) / 60000) : '-';
          const formatTime = (dateObj) => dateObj ? `${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')}` : '-';
          const spotDisplayText = record.spotNumber ? record.spotNumber : '無';
          const rowClass = !record.spotNumber ? 'bg-yellow-50' : 'bg-white';
          const row = `<tr class="${rowClass}">
              <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${record.licensePlate}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.unit}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${spotDisplayText}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatTime(entry)}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatTime(exit)}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${duration}</td>
            </tr>`;
          this.elements.recordsTableBody.insertAdjacentHTML('beforeend', row);
        });
      },

      displayPresentVehicles() {
          this.elements.vehiclesPresentContainer.innerHTML = '';
          if (this.vehicles.length === 0) {
              this.elements.vehiclesPresentContainer.innerHTML = '<p class="text-gray-500">目前沒有在場車輛。</p>';
              return;
          }
          this.vehicles.forEach(v => {
              const entry = this.parseTimestamp(v.entryTime);
              const timeStr = entry ? `${entry.getHours().toString().padStart(2, '0')}:${entry.getMinutes().toString().padStart(2, '0')}` : '時間錯誤';
              const vehicleHTML = `<div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg">
                    <div>
                        <p class="font-bold text-gray-800">${v.licensePlate}</p>
                        <p class="text-sm text-gray-600">${v.unit} - 入場於 ${timeStr}</p>
                    </div>
                    <button data-id="${v.id}" class="btn bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-1 px-3 rounded-md">出場</button>
                </div>`;
              this.elements.vehiclesPresentContainer.insertAdjacentHTML('beforeend', vehicleHTML);
          });
      },
      
      updateChart() {
        const hourlyCounts = new Array(24).fill(0);
        this.records.forEach(record => {
            const entry = this.parseTimestamp(record.entryTime);
            if (entry) { hourlyCounts[entry.getHours()]++; }
        });
        this.entryTimeChart.data.datasets[0].data = hourlyCounts;
        this.entryTimeChart.update();
      },

      filterRecords(searchTerm) {
          const lowerCaseSearch = searchTerm.toLowerCase();
          if (!lowerCaseSearch) { this.displayRecords(this.records); return; }
          const filtered = this.records.filter(r => 
              r.licensePlate.toLowerCase().includes(lowerCaseSearch) ||
              r.unit.toLowerCase().includes(lowerCaseSearch)
          );
          this.displayRecords(filtered);
      },

      async addRecord(e) {
        e.preventDefault();
        const plate = this.elements.licensePlateInput.value.trim().toUpperCase();
        const unit = this.elements.unitInput.value.trim().toUpperCase();
        if (!plate || !unit) { alert('車牌和戶別為必填項。'); return; }
        const newRecord = {
          licensePlate: plate, unit: unit, spotNumber: this.retrievedSpotNumber,
          entryTime: serverTimestamp(),
          entryDate: new Date().toISOString().split('T')[0],
          exitTime: null, status: 'present'
        };
        try {
          await addDoc(collection(this.db, 'parking_records'), newRecord);
          this.elements.newRecordForm.reset();
          this.elements.spotStatusDisplay.textContent = '-';
          this.retrievedSpotNumber = '';
        } catch (error) {
          console.error("新增記錄失敗: ", error);
          alert('新增記錄失敗，請檢查網路連線或稍後再試。');
        }
      },

      async checkOut(docId) {
        if (!docId) return;
        const recordRef = doc(this.db, 'parking_records', docId);
        try {
          await updateDoc(recordRef, {
            exitTime: serverTimestamp(),
            status: 'departed'
          });
        } catch (error) {
            console.error("更新出場時間失敗: ", error);
            alert('更新出場時間失敗，請檢查網路連線或稍後再試。');
        }
      },

      exportToCsv() {
        if (this.records.length === 0) { alert('沒有記錄可匯出。'); return; }
        let csvContent = "\uFEFF";
        csvContent += "車牌號碼,戶別,車位編號,入場時間,出場時間,停放時長(分)\n";
        this.records.forEach(record => {
            const entry = this.parseTimestamp(record.entryTime);
            const exit = this.parseTimestamp(record.exitTime);
            const formatTime = (dateObj) => {
                if (!dateObj) return '';
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const hours = String(dateObj.getHours()).padStart(2, '0');
                const minutes = String(dateObj.getMinutes()).padStart(2, '0');
                return `${year}/${month}/${day} ${hours}:${minutes}`;
            };
            const duration = (entry && exit) ? Math.round((exit - entry) / 60000) : '';
            const spotCsvText = record.spotNumber ? record.spotNumber : '無';
            csvContent += `${record.licensePlate},${record.unit},${spotCsvText},${formatTime(entry)},${formatTime(exit)},${duration}\n`;
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `parking_log_${this.selectedDate}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      },
    };

    document.addEventListener('DOMContentLoaded', () => App.init());
  </script>
</body>
</html>