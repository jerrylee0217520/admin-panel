<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>停車管理中心</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-color: #f0f2f5;
    }
    .card {
      background-color: white;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      transition: all 0.3s ease-in-out;
    }
    .card:hover {
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    .btn {
      transition: all 0.2s ease-in-out;
    }
    .btn:hover {
      transform: translateY(-2px);
    }
  </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

  <div class="max-w-7xl mx-auto">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800">佳元松江社區 停車管理中心</h1>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <div class="lg:col-span-1 flex flex-col gap-6">
        <div class="card p-6">
          <h2 class="text-xl font-bold mb-4">新增停車記錄</h2>
          <form id="new-record-form" class="space-y-4">
            <div>
              <label for="license-plate-input" class="block text-sm font-medium text-gray-700">車牌號碼:</label>
              <input type="text" id="license-plate-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="ABC-1234">
            </div>
            <div>
              <label for="unit-input" class="block text-sm font-medium text-gray-700">戶別:</label>
              <input type="text" id="unit-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="例如: 5C, 施工, 或貴賓">
            </div>
            <button type="submit" class="w-full btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">
              新增停車
            </button>
          </form>
        </div>

        <div class="card p-6">
          <h2 class="text-xl font-bold mb-4">在場車輛</h2>
          <div id="vehicles-present-container" class="space-y-3">
            <p class="text-gray-500">目前沒有在場車輛。</p>
            </div>
        </div>
      </div>

      <div class="lg:col-span-2 flex flex-col gap-6">
        <div class="card p-6">
            <h2 class="text-xl font-bold mb-4">數據分析</h2>
            <p class="text-sm text-gray-600 mb-4">今日各時段入場車流量分析</p>
            <div class="h-64">
              <canvas id="entry-time-chart"></canvas>
            </div>
        </div>
        <div class="card p-6">
          <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
              <h2 class="text-xl font-bold">今日停車總記錄</h2>
              <div class="w-full sm:w-auto">
                  <input type="text" id="search-input" class="w-full sm:w-64 block rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="搜尋車牌或戶別...">
              </div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">車牌號碼</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">戶別</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">入場時間</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">出場時間</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">停放時長 (分)</th>
                </tr>
              </thead>
              <tbody id="records-table-body" class="bg-white divide-y divide-gray-200">
                </tbody>
            </table>
          </div>
          <div class="mt-6 text-right">
              <button id="export-csv-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                  匯出今日記錄 (CSV)
              </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDeRHsloR1iY0_bzpYbPzdCiBljGfck98k",
      authDomain: "jy-2025.firebaseapp.com",
      projectId: "jy-2025",
      storageBucket: "jy-2025.appspot.com",
      messagingSenderId: "640527461851",
      appId: "1:640527461851:web:eed9f82d698275371fcbfe",
    };

    const App = {
      db: null,
      elements: {},
      records: [],
      vehicles: [],
      entryTimeChart: null,

      init() {
        const app = initializeApp(firebaseConfig);
        this.db = getFirestore(app);
        
        this.cacheDOMElements();
        this.bindEvents();
        this.loadAndDisplayRecords();
        this.listenForPresentVehicles();
        this.initChart();
      },

      cacheDOMElements() {
        this.elements = {
          newRecordForm: document.getElementById('new-record-form'),
          licensePlateInput: document.getElementById('license-plate-input'),
          unitInput: document.getElementById('unit-input'),
          vehiclesPresentContainer: document.getElementById('vehicles-present-container'),
          recordsTableBody: document.getElementById('records-table-body'),
          searchInput: document.getElementById('search-input'),
          exportCsvBtn: document.getElementById('export-csv-btn'),
          chartCanvas: document.getElementById('entry-time-chart'),
        };
      },

      bindEvents() {
        this.elements.newRecordForm.addEventListener('submit', (e) => this.addRecord(e));
        this.elements.vehiclesPresentContainer.addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON') {
            this.checkOut(e.target.dataset.id);
          }
        });
        this.elements.searchInput.addEventListener('input', (e) => this.filterRecords(e.target.value));
        this.elements.exportCsvBtn.addEventListener('click', () => this.exportToCsv());
      },
      
      initChart() {
        const ctx = this.elements.chartCanvas.getContext('2d');
        const labels = Array.from({ length: 24 }, (_, i) => `${i}時`);
        this.entryTimeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '入場車輛數',
                    data: new Array(24).fill(0),
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
      },

      async loadAndDisplayRecords() {
        const todayStr = new Date().toISOString().split('T')[0];
        const recordsRef = collection(this.db, 'parking_records');
        const q = query(recordsRef, where("entryDate", "==", todayStr));

        onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const data = { id: change.doc.id, ...change.doc.data() };
                if (change.type === "added") {
                    this.records.unshift(data);
                }
                if (change.type === "modified") {
                    const index = this.records.findIndex(rec => rec.id === data.id);
                    if (index > -1) this.records[index] = data;
                }
                if (change.type === "removed") {
                    this.records = this.records.filter(rec => rec.id !== data.id);
                }
            });
            this.records.sort((a,b) => b.entryTime.localeCompare(a.entryTime));
            this.displayRecords();
            this.updateChart();
        });
      },

      listenForPresentVehicles() {
        const recordsRef = collection(this.db, 'parking_records');
        const q = query(recordsRef, where("status", "==", "present"));
        onSnapshot(q, (snapshot) => {
            this.vehicles = [];
            snapshot.forEach(doc => {
                this.vehicles.push({ id: doc.id, ...doc.data() });
            });
            this.displayPresentVehicles();
        });
      },

      displayRecords(recordsToDisplay = this.records) {
        this.elements.recordsTableBody.innerHTML = '';
        if (recordsToDisplay.length === 0) {
          this.elements.recordsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-4">今日尚無停車記錄。</td></tr>`;
          return;
        }

        recordsToDisplay.forEach(record => {
          const entry = new Date(record.entryTime);
          const exit = record.exitTime ? new Date(record.exitTime) : null;
          const duration = exit ? Math.round((exit - entry) / 60000) : '-';
          const exitTimeStr = exit ? `${exit.getHours().toString().padStart(2, '0')}:${exit.getMinutes().toString().padStart(2, '0')}` : '-';

          const row = `
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${record.licensePlate}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.unit}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${entry.getHours().toString().padStart(2, '0')}:${entry.getMinutes().toString().padStart(2, '0')}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${exitTimeStr}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${duration}</td>
            </tr>`;
          this.elements.recordsTableBody.insertAdjacentHTML('beforeend', row);
        });
      },

      displayPresentVehicles() {
          this.elements.vehiclesPresentContainer.innerHTML = '';
          if (this.vehicles.length === 0) {
              this.elements.vehiclesPresentContainer.innerHTML = '<p class="text-gray-500">目前沒有在場車輛。</p>';
              return;
          }
          this.vehicles.forEach(v => {
              const entry = new Date(v.entryTime);
              const timeStr = `${entry.getHours().toString().padStart(2, '0')}:${entry.getMinutes().toString().padStart(2, '0')}`;
              const vehicleHTML = `
                <div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg">
                    <div>
                        <p class="font-bold text-gray-800">${v.licensePlate}</p>
                        <p class="text-sm text-gray-600">${v.unit} - 入場於 ${timeStr}</p>
                    </div>
                    <button data-id="${v.id}" class="btn bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-1 px-3 rounded-md">出場</button>
                </div>
              `;
              this.elements.vehiclesPresentContainer.insertAdjacentHTML('beforeend', vehicleHTML);
          });
      },
      
      updateChart() {
        const hourlyCounts = new Array(24).fill(0);
        this.records.forEach(record => {
            const entryHour = new Date(record.entryTime).getHours();
            hourlyCounts[entryHour]++;
        });
        this.entryTimeChart.data.datasets[0].data = hourlyCounts;
        this.entryTimeChart.update();
      },

      filterRecords(searchTerm) {
          const lowerCaseSearch = searchTerm.toLowerCase();
          if (!lowerCaseSearch) {
              this.displayRecords(this.records);
              return;
          }
          const filtered = this.records.filter(r => 
              r.licensePlate.toLowerCase().includes(lowerCaseSearch) ||
              r.unit.toLowerCase().includes(lowerCaseSearch)
          );
          this.displayRecords(filtered);
      },

      async addRecord(e) {
        e.preventDefault();
        const plate = this.elements.licensePlateInput.value.trim().toUpperCase();
        const unit = this.elements.unitInput.value.trim();

        if (!plate || !unit) {
          alert('車牌和戶別為必填項。');
          return;
        }

        const now = new Date();
        const newRecord = {
          licensePlate: plate,
          unit: unit,
          entryTime: now.toISOString(),
          entryDate: now.toISOString().split('T')[0],
          exitTime: null,
          status: 'present' // 'present' or 'departed'
        };

        const docId = `${newRecord.entryDate}_${plate}`;
        
        try {
          await setDoc(doc(this.db, 'parking_records', docId), newRecord);
          this.elements.newRecordForm.reset();
        } catch (error) {
          console.error("新增記錄失敗: ", error);
          alert('新增記錄失敗，請檢查網路連線或稍後再試。');
        }
      },

      async checkOut(docId) {
        if (!docId) return;
        const now = new Date();
        const recordRef = doc(this.db, 'parking_records', docId);
        
        try {
          // Use updateDoc instead of setDoc with merge to avoid overwriting
          const { updateDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
          await updateDoc(recordRef, {
            exitTime: now.toISOString(),
            status: 'departed'
          });
        } catch (error) {
            console.error("更新出場時間失敗: ", error);
            alert('更新出場時間失敗，請檢查網路連線或稍後再試。');
        }
      },

      exportToCsv() {
        if (this.records.length === 0) {
            alert('沒有記錄可匯出。');
            return;
        }

        let csvContent = "\uFEFF"; // BOM for UTF-8
        csvContent += "車牌號碼,戶別,入場時間,出場時間,停放時長\n";

        this.records.forEach(record => {
            const entry = new Date(record.entryTime);
            const exit = record.exitTime ? new Date(record.exitTime) : null;
            const entryTimeStr = `${entry.getHours().toString().padStart(2, '0')}:${entry.getMinutes().toString().padStart(2, '0')}`;
            const exitTimeStr = exit ? `${exit.getHours().toString().padStart(2, '0')}:${exit.getMinutes().toString().padStart(2, '0')}` : '';
            const duration = exit ? Math.round((exit - entry) / 60000) : '';

            csvContent += `${record.licensePlate},${record.unit},${entryTimeStr},${exitTimeStr},${duration}\n`;
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `parking_log_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      },
    };

    // ##### THIS IS THE MISSING LINE TO START THE APP #####
    document.addEventListener('DOMContentLoaded', () => App.init());

  </script>
</body>
</html>