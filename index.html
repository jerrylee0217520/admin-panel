<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>AI 智慧停車巡檢工具</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></link>
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff"/>
  <style>
    html, body {
      overscroll-behavior-y: contain;
      background: #f0f4f8;
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
    }
    .btn-ai {
      transition: all 0.3s ease;
    }
    .btn-ai:active {
      transform: scale(0.95);
      background-color: #1e40af;
    }
    .status-message {
      transition: all 0.3s ease;
    }
    .spinner {
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="antialiased">
  <div class="max-w-md mx-auto bg-white p-6 rounded-b-xl shadow-lg">
    <div class="text-center">
      <h1 class="text-2xl font-bold text-gray-800">AI 智慧停車巡檢工具</h1>
      <p class="text-gray-500 mt-2">用語音或拍照，快速登記車輛</p>
    </div>

    <div class="mt-4 text-center">
        <button id="auth-button" class="py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition duration-150">登入 Google</button>
        <p id="user-status" class="mt-2 text-sm text-gray-500">正在初始化...</p>
    </div>
    
    <main id="main-content" class="hidden">
        <div id="error-message" class="mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative hidden" role="alert">
          <strong class="font-bold">錯誤：</strong>
          <span class="block sm:inline" id="error-text"></span>
        </div>

        <div class="mt-6 space-y-4">
          <div>
            <label for="carPlate" class="block text-sm font-medium text-gray-700">車牌號碼:</label>
            <input type="text" id="carPlate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-3 text-lg uppercase" placeholder="待辨識...">
          </div>
          <div>
            <label for="huBei" class="block text-sm font-medium text-gray-700">戶別:</label>
            <input type="text" id="huBei" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-3 text-lg uppercase" placeholder="輸入簡碼後自動匹配...">
          </div>
          <div>
              <label class="block text-sm font-medium text-gray-700">車位狀態:</label>
              <p id="spot-status-display" class="mt-1 text-lg font-bold text-gray-800">-</p>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-2 gap-4">
          <button id="voiceBtn" class="btn-ai flex flex-col items-center justify-center p-4 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700">
            <i class="fas fa-microphone-alt fa-2x"></i>
            <span class="mt-2 text-sm font-medium">語音輸入</span>
          </button>
          <button id="cameraBtn" class="btn-ai flex flex-col items-center justify-center p-4 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700">
            <i class="fas fa-camera-retro fa-2x"></i>
            <span class="mt-2 text-sm font-medium">拍照辨識</span>
          </button>
          <input type="file" id="imageUpload" class="hidden" accept="image/*" capture="environment">
        </div>

        <div id="statusMessage" class="status-message text-center text-gray-600 mt-4 h-6"></div>

        <div class="mt-4">
          <button id="addRecordBtn" class="w-full py-4 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-400">
            <span id="addBtnText">新增停車</span>
            <div id="addBtnSpinner" class="spinner w-6 h-6 border-4 border-white rounded-full hidden mx-auto"></div>
          </button>
        </div>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const USER_PROVIDED_API_KEY = "AIzaSyCspWUkVA6STWgjrLeXVgg5JnWnJWTKAtU";
    
    const firebaseConfig = {
        apiKey: "AIzaSyDeRHsloR1iY0_bzpYbPzdCiBljGfck98k",
        authDomain: "jy-2025.firebaseapp.com",
        projectId: "jy-2025",
        storageBucket: "jy-2025.appspot.com",
        messagingSenderId: "640527461851",
        appId: "1:640527461851:web:eed9f82d698275371fcbfe",
    };
    
    const ADMIN_UIDS = ["KcaxVmcqI3RzxWdhCl2dhVGPxti1", "8dYFqXhM4gVQr9MTEI5z3P4Xn9p2"];

    const carPlateInput = document.getElementById('carPlate');
    const huBeiInput = document.getElementById('huBei');
    const addRecordBtn = document.getElementById('addRecordBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const imageUpload = document.getElementById('imageUpload');
    const statusMessage = document.getElementById('statusMessage');
    const errorMessageEl = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const addBtnText = document.getElementById('addBtnText');
    const addBtnSpinner = document.getElementById('addBtnSpinner');
    const authButton = document.getElementById('auth-button');
    const userStatus = document.getElementById('user-status');
    const mainContent = document.getElementById('main-content');
    const spotStatusDisplay = document.getElementById('spot-status-display');
    
    let db, auth, user;
    let retrievedSpotNumber = '';
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    const allHuBeiList = [
        '10A-10樓', '10B-10樓', '9A-9樓', '9B-9樓', '8A-8樓', '8B-8樓',
        '7A-7樓', '7B-7樓', '7C-7樓', '7D-7樓', '7E-7樓', '7F-7樓',
        '6A-6樓', '6B-6樓', '6C-6樓', '6D-6樓', '6E-6樓', '6F-6樓',
        '5A-5樓', '5B-5樓', '5C-5樓', '5D-5樓', '5E-5樓', '5F-5樓',
        '4A-4樓', '4B-4樓', '4CD-4樓', '4EF-4樓', '3A-3樓', '3B-3樓',
        '3CD-3樓', '3EF-3樓', '2A-2樓', '2B-2樓', '2C-2樓', '2D-2樓',
        '2E-2樓', '2F-2樓', '1A-1樓', '1B-1樓', '施工', '貴賓'
    ];

    function showError(message) {
      errorText.textContent = message;
      errorMessageEl.classList.remove('hidden');
    }

    function hideError() {
      errorMessageEl.classList.add('hidden');
    }

    function findFullHuBei(shorthandInput) {
        const input = String(shorthandInput).toUpperCase().trim();
        if (!input) return shorthandInput;
        if (input === 'VIP') return '貴賓';
        const matchedHuBei = allHuBeiList.find(fullHuBei => fullHuBei.toUpperCase().startsWith(input));
        return matchedHuBei || shorthandInput;
    }

    async function initializeFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        onAuthStateChanged(auth, (currentUser) => {
            user = currentUser;
            updateAuthUI();
        });
      } catch (e) {
        console.error("Firebase Initialization failed:", e);
        showError("無法連接至伺服器。");
      }
    }

    async function handleAuth() {
        if (user) {
            await signOut(auth);
        } else {
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("登入失敗:", error);
                showError("Google 登入失敗。");
            }
        }
    }

    function updateAuthUI() {
        if (user && ADMIN_UIDS.includes(user.uid)) {
            userStatus.textContent = `管理員已登入: ${user.displayName || user.email}`;
            authButton.textContent = '登出';
            mainContent.classList.remove('hidden');
        } else {
            userStatus.textContent = '請登入管理員帳號以繼續。';
            authButton.textContent = '登入 Google';
            mainContent.classList.add('hidden');
        }
    }

    function getApiKey() {
        const key = USER_PROVIDED_API_KEY || firebaseConfig.apiKey;
        if (!key) {
            showError("錯誤：未設定 AI API 金鑰。");
            return null;
        }
        return key;
    }

    function setupSpeechRecognition() {
      if (!SpeechRecognition) {
        showError("您的瀏覽器不支援語音辨識功能。");
        voiceBtn.disabled = true;
        return;
      }
      recognition = new SpeechRecognition();
      recognition.lang = 'zh-TW';
      recognition.interimResults = false;
      recognition.onstart = () => { statusMessage.textContent = '正在聆聽...'; };
      recognition.onresult = async (event) => {
        const speechResult = event.results[0][0].transcript;
        statusMessage.textContent = `正在處理: "${speechResult}"`;
        await parseSpeechWithAI(speechResult);
      };
      recognition.onerror = (event) => {
        showError(`語音辨識錯誤: ${event.error}`);
        statusMessage.textContent = '';
      };
    }

    async function parseSpeechWithAI(text) {
        const apiKey = getApiKey();
        if (!apiKey) return;
        try {
            const prompt = `從以下這段中文語句中，提取出車牌號碼和戶別資訊。車牌號碼通常由英文字母和數字組成。戶別可能是樓層、房號，或是如"施工"、"貴賓"等特殊詞彙。請以JSON格式回傳，鍵值分別為 'carPlate' 和 'huBei'。語句: "${text}"`;
            const payload = {
              contents: [{ role: "user", parts: [{ text: prompt }] }],
              generationConfig: {
                  responseMimeType: "application/json",
                  responseSchema: { type: "OBJECT", properties: { "carPlate": { "type": "STRING" }, "huBei": { "type": "STRING" } }, required: ["carPlate", "huBei"] }
              }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { throw new Error(`API 請求失敗: ${response.status}.`); }
            const result = await response.json();
            if (result.candidates && result.candidates[0]) {
                const parsedJson = JSON.parse(result.candidates[0].content.parts[0].text);
                if (parsedJson.carPlate) { carPlateInput.value = parsedJson.carPlate.toUpperCase().replace(/\s|-/g, ''); }
                if (parsedJson.huBei) { 
                    huBeiInput.value = parsedJson.huBei.toUpperCase();
                    huBeiInput.dispatchEvent(new Event('change'));
                }
                statusMessage.textContent = 'AI 辨識完成！';
            } else { throw new Error('無效的 AI 回應。'); }
        } catch (error) {
            console.error('AI 語音解析錯誤:', error);
            showError(`AI 語音解析失敗: ${error.message}`);
        } finally {
            setTimeout(() => { if (statusMessage.textContent === 'AI 辨識完成！') statusMessage.textContent = ''; }, 2000);
        }
    }

    async function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const apiKey = getApiKey();
        if (!apiKey) return;
        statusMessage.textContent = '正在辨識圖片...';
        addRecordBtn.disabled = true;
        const reader = new FileReader();
        reader.onloadend = async () => {
            const base64ImageData = reader.result.split(',')[1];
            try {
                const prompt = "從這張圖片中辨識出車牌號碼，並以JSON格式回傳。車牌號碼的鍵是 'carPlate'。";
                const payload = {
                  contents: [ { role: "user", parts: [ { text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } } ] } ],
                  generationConfig: {
                      responseMimeType: "application/json",
                      responseSchema: { type: "OBJECT", properties: { "carPlate": { "type": "STRING" } }, required: ["carPlate"] }
                  }
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { throw new Error(`API 請求失敗: ${response.status}.`); }
                const result = await response.json();
                if (result.candidates && result.candidates[0]) {
                    const parsedJson = JSON.parse(result.candidates[0].content.parts[0].text);
                    if (parsedJson.carPlate) {
                        carPlateInput.value = parsedJson.carPlate.toUpperCase().replace(/\s|-/g, '');
                        statusMessage.textContent = '車牌辨識成功！';
                    } else { throw new Error('AI 未能辨識出車牌。'); }
                } else { throw new Error('無效的 AI 回應。'); }
            } catch (error) {
                console.error('AI 辨識錯誤:', error);
                showError(`AI 辨識失敗: ${error.message}`);
            } finally {
                addRecordBtn.disabled = false;
                imageUpload.value = '';
                setTimeout(() => { if (statusMessage.textContent === '車牌辨識成功！') statusMessage.textContent = ''; }, 2000);
            }
        };
        reader.readAsDataURL(file);
    }
    
    async function handleHuBeiChange() {
        const shorthandInput = huBeiInput.value;
        if (!shorthandInput.trim()) {
            spotStatusDisplay.textContent = '-';
            retrievedSpotNumber = '';
            return;
        }
        
        const fullHuBei = findFullHuBei(shorthandInput);
        huBeiInput.value = fullHuBei;

        spotStatusDisplay.textContent = '查詢中...';
        const spotRef = doc(db, 'unit_parking_spots', fullHuBei.toUpperCase());
        try {
            const spotSnap = await getDoc(spotRef);
            if (spotSnap.exists()) {
                const spotNumber = spotSnap.data().spotNumber || '資料有誤';
                spotStatusDisplay.textContent = spotNumber;
                retrievedSpotNumber = spotNumber;
            } else {
                spotStatusDisplay.textContent = '無';
                retrievedSpotNumber = '';
            }
        } catch (error) {
            console.error("查詢車位失敗:", error);
            spotStatusDisplay.textContent = '查詢失敗';
            retrievedSpotNumber = '';
        }
    }

    async function addRecord() {
      const carPlate = carPlateInput.value.trim().toUpperCase();
      const huBei = huBeiInput.value.trim();
      if (!carPlate || !huBei) {
        showError('車牌號碼和戶別不能為空。');
        return;
      }
      hideError();
      addBtnText.classList.add('hidden');
      addBtnSpinner.classList.remove('hidden');
      addRecordBtn.disabled = true;
      
      const now = new Date();
      const docId = `${now.toISOString().split('T')[0]}_${carPlate.replace(/[^a-zA-Z0-9]/g, '')}`;
      
      try {
        await setDoc(doc(db, 'parking_records', docId), {
          licensePlate: carPlate, 
          unit: huBei, 
          spotNumber: retrievedSpotNumber,
          entryTime: serverTimestamp(), 
          entryDate: now.toISOString().split('T')[0],
          exitTime: null,
          status: 'present'
        });
        carPlateInput.value = ''; 
        huBeiInput.value = '';
        spotStatusDisplay.textContent = '-';
        retrievedSpotNumber = '';
        statusMessage.textContent = '新增成功！';
        setTimeout(() => statusMessage.textContent = '', 2000);
      } catch (e) {
        showError("新增記錄失敗，請檢查網路連線。");
        console.error("Add record error:", e);
      } finally {
        addBtnText.classList.remove('hidden');
        addBtnSpinner.classList.add('hidden');
        addRecordBtn.disabled = false;
      }
    }
    
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }

    voiceBtn.addEventListener('click', () => { if (recognition) recognition.start(); });
    cameraBtn.addEventListener('click', () => { imageUpload.click(); });
    imageUpload.addEventListener('change', handleImageUpload);
    huBeiInput.addEventListener('change', handleHuBeiChange);
    addRecordBtn.addEventListener('click', addRecord);
    authButton.addEventListener('click', handleAuth);

    initializeFirebase();
    setupSpeechRecognition();

  </script>
</body>
</html>
